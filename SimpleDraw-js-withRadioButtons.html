<!DOCTYPE html>
<html>
<body>

<script language="JavaScript">
var MODE_DRAW = 1;
var MODE_SELECT = 2;
var MODE_MOVE = 3;
var mode = MODE_DRAW;

// Couleur par défaut des traits
var selectedColor = "#000000"; 

</script>

<canvas id="myCanvas" width="500" height="600" style="border:2px solid #000000;"> </canvas>
<br/>
<label><input type='radio' name="radio_mode" onclick='setMode(MODE_DRAW);' checked>Draw</label>
<label><input type='radio' name="radio_mode" onclick='setMode(MODE_SELECT);'>Rectangle Select</label>
<label><input type='radio' name="radio_mode" onclick='setMode(MODE_MOVE);'>Move Selection</label>
<button onclick="clearButtonHandler()">Delete All</button>

<!-- Titre pour la palette de couleurs -->
<h3>Palette de couleurs</h3>

<!-- Les boutons de couleur déplacés sous les boutons radio avec espacement et bordure jaune pour la couleur active -->
<div style="display: flex; gap: 10px; margin-top: 10px;">
    <button id="btnNoir" onclick="setColor('#000000')" style="background-color: #000000; width: 30px; height: 30px; border: 3px solid yellow;"></button>
    <button id="btnRouge" onclick="setColor('#FF0000')" style="background-color: #FF0000; width: 30px; height: 30px; border: 3px solid black;"></button>
    <button id="btnVert" onclick="setColor('#00FF00')" style="background-color: #00FF00; width: 30px; height: 30px; border: 3px solid black;"></button>
    <button id="btnBleu" onclick="setColor('#0000FF')" style="background-color: #0000FF; width: 30px; height: 30px; border: 3px solid black;"></button>
</div>

<script language="JavaScript">

var canvas = document.getElementById("myCanvas");
var canvas_context = canvas.getContext("2d");

var mouse_drag_start_x = 0;
var mouse_drag_start_y = 0;
var mouse_previous_x = 0;
var mouse_previous_y = 0;
var buttonIsDown = false;

var arrayOfStrokes = [];
var selectedStrokes = [];
var stroke = [];

// Cette variable stockera le rectangle temporaire pour la sélection
var selectionRectangle = null;
var isMoving = false; // Variable pour vérifier si nous sommes en train de déplacer la sélection

function mouseDownHandler(e) {
	buttonIsDown = true;
	var canvas_rectangle = canvas.getBoundingClientRect();
	var event_x = e.clientX - canvas_rectangle.left;
	var event_y = e.clientY - canvas.getBoundingClientRect().top;

	stroke = [];
	switch ( mode ) {
		case MODE_DRAW :
			stroke.push( { x : event_x, y : event_y, color: selectedColor } );
			// Désélectionner tous les traits lorsque l'on commence à dessiner
			selectedStrokes = [];
			break;
		case MODE_SELECT :
			selectionRectangle = { x1: event_x, y1: event_y, x2: event_x, y2: event_y };
			break;
		case MODE_MOVE :
			if (selectedStrokes.length > 0) {
				isMoving = true; // Commencer à déplacer la sélection
			}
			break;
	}
	mouse_drag_start_x = mouse_previous_x = event_x;
	mouse_drag_start_y = mouse_previous_y = event_y;
}

function mouseUpHandler(e) {
	buttonIsDown = false;
	var canvas_rectangle = canvas.getBoundingClientRect();
	var event_x = e.clientX - canvas_rectangle.left;
	var event_y = e.clientY - canvas.getBoundingClientRect().top;

	switch ( mode ) {
		case MODE_DRAW :
			if ( stroke.length > 2 ) {
				arrayOfStrokes.push( stroke );
			}
			stroke = [];
			break;
		case MODE_SELECT :
			// À la fin du glissement, nous devons sélectionner les traits dans le rectangle
			selectStrokesInRectangle(selectionRectangle);
			selectionRectangle = null;
			break;
		case MODE_MOVE :
			isMoving = false; // Arrêter le déplacement
			break;
	}
	mouse_previous_x = event_x;
	mouse_previous_y = event_y;
}

function mouseMoveHandler(e) {
	var canvas_rectangle = canvas.getBoundingClientRect();
	var event_x = e.clientX - canvas_rectangle.left;
	var event_y = e.clientY - canvas.getBoundingClientRect().top;

	switch ( mode ) {
		case MODE_DRAW :
			if ( buttonIsDown ) {
				stroke.push( { x : event_x, y : event_y, color: selectedColor } );
			}
			break;
		case MODE_SELECT :
			if (buttonIsDown) {
				// Mettre à jour la position du rectangle de sélection pendant le glissement
				selectionRectangle.x2 = event_x;
				selectionRectangle.y2 = event_y;
			}
			break;
		case MODE_MOVE :
			if (buttonIsDown && isMoving) {
				// Calculer le décalage de la souris pour déplacer les traits sélectionnés
				var offsetX = event_x - mouse_previous_x;
				var offsetY = event_y - mouse_previous_y;
				moveSelectedStrokes(offsetX, offsetY);
			}
			break;
	}

	redraw();
	mouse_previous_x = event_x;
	mouse_previous_y = event_y;
}

canvas.addEventListener('mousedown',mouseDownHandler);
canvas.addEventListener('mouseup',mouseUpHandler);
canvas.addEventListener('mousemove',mouseMoveHandler);

function drawStroke( s, isSelected = false ) {
	canvas_context.beginPath();
	canvas_context.strokeStyle = s[0].color || "#000000"; // Utiliser la couleur de chaque trait
	canvas_context.lineWidth = 1; // Rétablir l'épaisseur normale des traits non sélectionnés
	for ( var i = 0; i < s.length; ++i ) {
		var x = s[i].x;
		var y = s[i].y;
		if ( i === 0 ) {
			canvas_context.moveTo(x,y);
		}
		else {
			canvas_context.lineTo(x,y);
		}
	}
	canvas_context.stroke(); // Dessiner le trait normal

	// Si le trait est sélectionné, ajouter une bordure jaune-orangée autour du trait
	if (isSelected) {
		canvas_context.lineWidth = 5; // Épaisseur de la bordure
		canvas_context.strokeStyle = "orange"; // Couleur de la bordure jaune-orangée
		canvas_context.stroke(); // Appliquer la bordure
	}
}

var redraw = function() {
	canvas_context.clearRect(0, 0, canvas.width, canvas.height);

	// Dessiner tous les traits
	for ( var i = 0; i < arrayOfStrokes.length; ++i ) {
		// Si le trait est sélectionné, on le dessine avec une bordure
		var isSelected = selectedStrokes.indexOf(arrayOfStrokes[i]) !== -1;
		drawStroke( arrayOfStrokes[i], isSelected );
	}

	// Dessiner le trait en cours de dessin
	if ( buttonIsDown && mode === MODE_DRAW ) {
		canvas_context.strokeStyle = selectedColor;
		drawStroke( stroke );
	}

	// Dessiner le rectangle de sélection s'il est actif
	if (selectionRectangle !== null) {
		canvas_context.strokeStyle = "#FF0000";
		canvas_context.strokeRect(
			selectionRectangle.x1, selectionRectangle.y1,
			selectionRectangle.x2 - selectionRectangle.x1, selectionRectangle.y2 - selectionRectangle.y1
		);
	}
}

function setMode(m) {
	mode = m;
	if (mode === MODE_DRAW) {
		// Désélectionner automatiquement tous les traits lorsqu'on passe en mode dessin
		selectedStrokes = [];
		redraw();
	}
}

function clearButtonHandler() {
	arrayOfStrokes = [];
	selectedStrokes = [];
	redraw();
}

function setColor(color) {
	selectedColor = color;
	updateSelectedColorBorder();
}

// Mettre à jour la bordure pour la couleur actuellement sélectionnée
function updateSelectedColorBorder() {
	var buttons = ["btnNoir", "btnRouge", "btnVert", "btnBleu"];
	buttons.forEach(function(buttonId) {
		var button = document.getElementById(buttonId);
		// Comparer les couleurs avec un format uniforme (RGB)
		var buttonColor = window.getComputedStyle(button).backgroundColor;
		var selectedRGBColor = hexToRGB(selectedColor);
		// Vérifier si la couleur sélectionnée est celle du bouton actuel
		button.style.border = (buttonColor === selectedRGBColor) ? "3px solid yellow" : "3px solid black";
	});
}

// Fonction pour convertir une couleur hexadécimale en format RGB
function hexToRGB(hex) {
	var r = parseInt(hex.slice(1, 3), 16);
	var g = parseInt(hex.slice(3, 5), 16);
	var b = parseInt(hex.slice(5, 7), 16);
	return `rgb(${r}, ${g}, ${b})`;
}

// Initialisation de la bordure à la couleur par défaut (noir)
updateSelectedColorBorder();

// Fonction pour déplacer les traits sélectionnés
function moveSelectedStrokes(offsetX, offsetY) {
	for (var i = 0; i < selectedStrokes.length; i++) {
		for (var j = 0; j < selectedStrokes[i].length; j++) {
			selectedStrokes[i][j].x += offsetX;
			selectedStrokes[i][j].y += offsetY;
		}
	}
	redraw();
}

// Fonction pour sélectionner les traits dans le rectangle
function selectStrokesInRectangle(rect) {
	selectedStrokes = [];
	for (var i = 0; i < arrayOfStrokes.length; i++) {
		var stroke = arrayOfStrokes[i];
		if (isStrokeInRectangle(stroke, rect)) {
			selectedStrokes.push(stroke);
		}
	}
	redraw();
}

// Fonction pour vérifier si un trait est dans le rectangle
function isStrokeInRectangle(stroke, rect) {
	// Déterminer les coordonnées minimales et maximales du rectangle pour prendre en compte toutes les directions
	var xMin = Math.min(rect.x1, rect.x2);
	var xMax = Math.max(rect.x1, rect.x2);
	var yMin = Math.min(rect.y1, rect.y2);
	var yMax = Math.max(rect.y1, rect.y2);

	// Vérifier si tous les points du trait sont dans les bornes du rectangle
	for (var i = 0; i < stroke.length; i++) {
		var point = stroke[i];
		if (point.x < xMin || point.x > xMax || point.y < yMin || point.y > yMax) {
			return false;
		}
	}
	return true;
}

</script>

</body>
</html>
