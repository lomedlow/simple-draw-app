<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas App Design</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7fc;
            display: flex;
            height: 100vh;
            justify-content: center;
            align-items: center;
            margin: 10px;
        }
        .container {
            display: flex;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        .sidebar {
            padding: 20px;
            width: 250px;
            background-color: #e9ecef;
            border-right: 2px solid #ddd;
        }
        .sidebar h3 {
            color: #333;
            margin-bottom: 15px;
        }
        .sidebar label {
            display: block;
            margin: 10px 0;
        }
        .sidebar hr {
            margin: 15px 0;
            border: none;
            border-top: 2px solid #ddd;
        }
        .palette {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .palette button {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid black;
        }
        .canvas-container {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #fafafa;
        }
        canvas {
            border: 3px solid #363636;
            background-color: #fff;
            margin-bottom: 20px;
        }
        button {
            background-color: #007bff;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 5px 0;
            opacity: 1;
        }
        button i {
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .disabled-button {
            opacity: 0.6;
            pointer-events: none;
        }
        .notification {
            color: green;
            margin-top: 10px;
        }
        #doubleClickAlert, #saveAlert {
            color: red;
            display: none;
        }
        .flex-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .save-buttons-container {
            display: flex;
			width: 100%;
            gap: 10px;
            justify-content: flex-start;
            margin-top: 10px;
        }
        .sidebar-section {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <h3>Modes</h3>
        <label><input type='radio' id="radio_draw" name="radio_mode" onclick='setMode(MODE_DRAW);' checked> <i class="fas fa-pencil-alt"></i> Draw</label>
        <label><input type='radio' id="radio_select" name="radio_mode" onclick='setMode(MODE_SELECT);'> <i class="fas fa-mouse-pointer"></i> Rectangle Select</label>
        <label><input type='radio' id="radio_move" name="radio_mode" onclick='setMode(MODE_MOVE);'> <i class="fas fa-arrows-alt"></i> Move Selection</label>
        <label><input type='radio' id="radio_erase" name="radio_mode" onclick='setMode(MODE_ERASE);'> <i class="fas fa-eraser"></i> Erase</label>

        <hr>
        <h3>Actions</h3>
        <button id="deleteButton" onclick="deleteSelection()" class="disabled-button" style="background-color:#fe4949;"><i class="fas fa-trash-alt"></i> Delete Selection</button>
        <button id="copyButton" onclick="copySelection()" class="disabled-button"><i class="fas fa-copy"></i> Copy Selection</button>
        <button onclick="clearButtonHandler()" style="border: 1px solid #FF0000; background-color:#fff; color:#FF0000;"><i class="fas fa-times"></i> Delete All</button>

        <hr>
        <h3>Features</h3>
        <div class="flex-row">
            <input type="checkbox" id="doubleClickToggle" onclick="toggleDoubleClick()"> 
            <label for="doubleClickToggle">Double-click (Draw/Erase)</label>
        </div>
        <div id="doubleClickNotification" class="notification" style="display: none;">
            <strong>Double Click Enabled:</strong> Double-click to toggle between "Draw" and "Erase".
        </div>
        <div id="doubleClickAlert" class="notification">
            <strong>Error:</strong> Double-click feature is not enabled!
        </div>

        <hr>
        <h3>Palette de couleurs</h3>
        <div class="palette">
            <button id="btnNoir" onclick="setColor('#000000')" style="background-color: #000000;"></button>
            <button id="btnRouge" onclick="setColor('#FF0000')" style="background-color:#FF0000;"></button>
            <button id="btnVert" onclick="setColor('#00FF00')" style="background-color: #00FF00;"></button>
            <button id="btnBleu" onclick="setColor('#0000FF')" style="background-color: #0000FF;"></button>
        </div>
    </div>

    <div class="canvas-container">
        <canvas id="myCanvas" width="500" height="600"></canvas>

        <div class="save-buttons-container">
            <button id="saveWithBg" onclick="saveCanvasAsImage(true)" class="disabled-button" style="background-color:#28a745;"><i class="fas fa-save"></i> Save with Background</button>
            <button id="saveWithoutBg" onclick="saveCanvasAsImage(false)" class="disabled-button" style="background-color:#28a745;"><i class="fas fa-save"></i> Save without Background</button>
        </div>
    </div>
</div>

<script language="JavaScript">
var MODE_DRAW = 1;
var MODE_SELECT = 2;
var MODE_MOVE = 3;
var MODE_ERASE = 4;
var mode = MODE_DRAW;
var selectedColor = "#000000"; 
var eraseRadius = 30; 
var copyOffset = 30;
var doubleClickEnabled = false;

var canvas = document.getElementById("myCanvas");
var canvas_context = canvas.getContext("2d");

var mouse_previous_x = 0;
var mouse_previous_y = 0;
var buttonIsDown = false;
var lastClickTime = 0;

var arrayOfStrokes = [];
var selectedStrokes = [];
var stroke = [];
var selectionRectangle = null;
var isMoving = false;

window.onload = function() {
    updateSelectedColorBorder();  // Mettre à jour la bordure de la couleur par défaut (noir)
};

// Gère le changement de mode
function setMode(newMode) {
    previousMode = mode;  
    mode = newMode;
    document.getElementById('radio_draw').checked = (mode === MODE_DRAW);
    document.getElementById('radio_select').checked = (mode === MODE_SELECT);
    document.getElementById('radio_move').checked = (mode === MODE_MOVE);
    document.getElementById('radio_erase').checked = (mode === MODE_ERASE);

    redraw();
    toggleSaveButtons(arrayOfStrokes.length > 0);  // Activer/désactiver les boutons de sauvegarde
}

// Gère l'activation du double-clic
function toggleDoubleClick() {
    doubleClickEnabled = document.getElementById("doubleClickToggle").checked;
    var notification = document.getElementById("doubleClickNotification");

    if (doubleClickEnabled) {
        notification.style.display = "block";
    } else {
        notification.style.display = "none";
    }
}

// Affiche une alerte temporaire
function showTemporaryAlert(message, alertId = "doubleClickAlert") {
    var alertBox = document.getElementById(alertId);
    alertBox.innerHTML = `<strong>Info:</strong> ${message}`;
    alertBox.style.display = "block";

    setTimeout(function() {
        alertBox.style.display = "none";
    }, 3000);
}

// Sauvegarde le canvas comme image
function saveCanvasAsImage(withBackground) {
    // Ignorer les traits sélectionnés (sans la bordure orange)
    var tempStrokes = selectedStrokes;
    selectedStrokes = [];
    redraw();

    var tempCanvas = document.createElement('canvas');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    var tempContext = tempCanvas.getContext('2d');

    if (withBackground) {
        tempContext.fillStyle = "#fff";  // Ajouter un fond blanc
        tempContext.fillRect(0, 0, canvas.width, canvas.height);
    }
    tempContext.drawImage(canvas, 0, 0);

    var link = document.createElement('a');
    link.download = 'canvas_image.png';
    link.href = tempCanvas.toDataURL();
    link.click();

    // Restaurer la sélection
    selectedStrokes = tempStrokes;
    redraw();

    showTemporaryAlert('Image saved successfully!', 'saveAlert');
}

// Gère le double-clic
function handleDoubleClick() {
    var currentTime = new Date().getTime();
    if (currentTime - lastClickTime < 300) {
        if (doubleClickEnabled) {
            if (mode !== MODE_DRAW && mode !== MODE_ERASE) {
                setMode(MODE_DRAW);
            } else if (mode === MODE_DRAW) {
                setMode(MODE_ERASE);
            } else if (mode === MODE_ERASE) {
                setMode(MODE_DRAW);
            }
        } else {
            showTemporaryAlert("Double-click feature is not enabled!");
        }
    }
    lastClickTime = currentTime;
}

// Fonction pour gérer les mouvements de la souris
function mouseDownHandler(e) {
    handleDoubleClick();  // Gérer le double-clic
    buttonIsDown = true;
    var canvas_rectangle = canvas.getBoundingClientRect();
    var event_x = e.clientX - canvas_rectangle.left;
    var event_y = e.clientY - canvas.getBoundingClientRect().top;

    stroke = [];
    switch (mode) {
        case MODE_DRAW:
            stroke.push({ x: event_x, y: event_y, color: selectedColor });
            selectedStrokes = []; 
            break;
        case MODE_SELECT:
            selectionRectangle = { x1: event_x, y1: event_y, x2: event_x, y2: event_y };
            break;
        case MODE_MOVE:
            if (selectedStrokes.length > 0) {
                isMoving = true;  
            }
            break;
        case MODE_ERASE:
            eraseStrokes(event_x, event_y); 
            break;
    }
    mouse_previous_x = event_x;
    mouse_previous_y = event_y;
}

// Fonction pour gérer le déplacement de la souris
function mouseMoveHandler(e) {
    var canvas_rectangle = canvas.getBoundingClientRect();
    var event_x = e.clientX - canvas_rectangle.left;
    var event_y = e.clientY - canvas.getBoundingClientRect().top;

    switch (mode) {
        case MODE_DRAW:
            if (buttonIsDown) {
                stroke.push({ x: event_x, y: event_y, color: selectedColor });
            }
            break;
        case MODE_SELECT:
            if (buttonIsDown) {
                selectionRectangle.x2 = event_x;
                selectionRectangle.y2 = event_y;
            }
            break;
        case MODE_MOVE:
            if (buttonIsDown && isMoving) {
                var offsetX = event_x - mouse_previous_x;
                var offsetY = event_y - mouse_previous_y;
                moveSelectedStrokes(offsetX, offsetY);  // Déplacement de la sélection
            }
            break;
        case MODE_ERASE:
            if (buttonIsDown) {
                eraseStrokes(event_x, event_y);
            }
            break;
    }

    redraw();
    mouse_previous_x = event_x;
    mouse_previous_y = event_y;
}

// Fonction pour gérer le relâchement de la souris
function mouseUpHandler(e) {
    buttonIsDown = false;
    var canvas_rectangle = canvas.getBoundingClientRect();
    var event_x = e.clientX - canvas_rectangle.left;
    var event_y = e.clientY - canvas.getBoundingClientRect().top;

    switch (mode) {
        case MODE_DRAW:
            if (stroke.length > 2) {
                arrayOfStrokes.push(stroke);
            }
            stroke = [];
            break;
        case MODE_SELECT:
            selectStrokesInRectangle(selectionRectangle);  // Sélection des traits dans le rectangle
            selectionRectangle = null;  // Effacer le rectangle après sélection
            break;
        case MODE_MOVE:
            isMoving = false;
            break;
    }
    mouse_previous_x = event_x;
    mouse_previous_y = event_y;
}

// Ajouter les écouteurs d'événements pour la souris
canvas.addEventListener('mousedown', mouseDownHandler);
canvas.addEventListener('mouseup', mouseUpHandler);
canvas.addEventListener('mousemove', mouseMoveHandler);

// Fonction pour dessiner un trait
function drawStroke(s, isSelected = false) {
    if (isSelected) {
        canvas_context.beginPath();
        canvas_context.strokeStyle = "orange"; 
        canvas_context.lineWidth = 8; 
        for (var i = 0; i < s.length; ++i) {
            var x = s[i].x;
            var y = s[i].y;
            if (i === 0) {
                canvas_context.moveTo(x, y);
            } else {
                canvas_context.lineTo(x, y);
            }
        }
        canvas_context.stroke();
    }

    canvas_context.beginPath();
    canvas_context.strokeStyle = s[0].color || "#000000";
    canvas_context.lineWidth = 2; 
    for (var i = 0; i < s.length; ++i) {
        var x = s[i].x;
        var y = s[i].y;
        if (i === 0) {
            canvas_context.moveTo(x, y);
        } else {
            canvas_context.lineTo(x, y);
        }
    }
    canvas_context.stroke();
}

// Fonction de redessin de tout le canvas
var redraw = function() {
    canvas_context.clearRect(0, 0, canvas.width, canvas.height);

    for (var i = 0; i < arrayOfStrokes.length; ++i) {
        var isSelected = selectedStrokes.indexOf(arrayOfStrokes[i]) !== -1;
        drawStroke(arrayOfStrokes[i], isSelected);
    }

    if (buttonIsDown && mode === MODE_DRAW) {
        canvas_context.strokeStyle = selectedColor;
        drawStroke(stroke);
    }

    if (selectionRectangle !== null) {
        canvas_context.strokeStyle = "#FF0000";
        canvas_context.strokeRect(
            selectionRectangle.x1, selectionRectangle.y1,
            selectionRectangle.x2 - selectionRectangle.x1, selectionRectangle.y2 - selectionRectangle.y1
        );
    }

    if (mode === MODE_ERASE) {
        canvas_context.beginPath();
        canvas_context.arc(mouse_previous_x, mouse_previous_y, eraseRadius, 0, 2 * Math.PI);
        canvas_context.strokeStyle = "#FF0000";
        canvas_context.lineWidth = 2;
        canvas_context.stroke();
    }

    toggleSaveButtons(arrayOfStrokes.length > 0);
}

// Activer/désactiver les boutons de sauvegarde
function toggleSaveButtons(enable) {
    document.getElementById("saveWithBg").classList.toggle("disabled-button", !enable);
    document.getElementById("saveWithoutBg").classList.toggle("disabled-button", !enable);
}

// Effacer tout le canvas
function clearButtonHandler() {
    arrayOfStrokes = [];
    selectedStrokes = [];
    redraw();
    toggleSaveButtons(false);  // Désactiver les boutons de sauvegarde
}

// Fonction pour définir la couleur sélectionnée
function setColor(color) {
    selectedColor = color;
    updateSelectedColorBorder();
}

// Mettre à jour la bordure de la couleur sélectionnée
function updateSelectedColorBorder() {
    var buttons = ["btnNoir", "btnRouge", "btnVert", "btnBleu"];
    buttons.forEach(function(buttonId) {
        var button = document.getElementById(buttonId);
        var buttonColor = window.getComputedStyle(button).backgroundColor;
        var selectedRGBColor = hexToRGB(selectedColor);
        button.style.border = (buttonColor === selectedRGBColor) ? "3px solid yellow" : "3px solid black";
    });
}

// Convertir les couleurs hexadécimales en RGB
function hexToRGB(hex) {
    var r = parseInt(hex.slice(1, 3), 16);
    var g = parseInt(hex.slice(3, 5), 16);
    var b = parseInt(hex.slice(5, 7), 16);
    return `rgb(${r}, ${g}, ${b})`;
}

// Déplacer les traits sélectionnés
function moveSelectedStrokes(offsetX, offsetY) {
    for (var i = 0; i < selectedStrokes.length; i++) {
        for (var j = 0; j < selectedStrokes[i].length; j++) {
            selectedStrokes[i][j].x += offsetX;
            selectedStrokes[i][j].y += offsetY;
        }
    }
    redraw();
}

// Effacer les traits dans le rayon d'effacement
function eraseStrokes(x, y) {
    for (var i = arrayOfStrokes.length - 1; i >= 0; i--) {
        var stroke = arrayOfStrokes[i];
        for (var j = 0; j < stroke.length; j++) {
            var point = stroke[j];
            var distance = Math.sqrt((point.x - x) ** 2 + (point.y - y) ** 2);
            if (distance < eraseRadius) {
                arrayOfStrokes.splice(i, 1); 
                break;
            }
        }
    }
    redraw();
}

// Sélectionner les traits dans un rectangle
function selectStrokesInRectangle(rect) {
    selectedStrokes = [];
    for (var i = 0; i < arrayOfStrokes.length; i++) {
        var stroke = arrayOfStrokes[i];
        if (isStrokeInRectangle(stroke, rect)) {
            selectedStrokes.push(stroke);
        }
    }

    // Activer ou désactiver les boutons selon la sélection
    toggleButtonsState(selectedStrokes.length > 0);
    redraw();
}

// Activer ou désactiver les boutons de sélection
function toggleButtonsState(enable) {
    document.getElementById("deleteButton").classList.toggle("disabled-button", !enable);
    document.getElementById("copyButton").classList.toggle("disabled-button", !enable);
}

// Fonction pour vérifier si un trait est dans le rectangle de sélection
function isStrokeInRectangle(stroke, rect) {
    var xMin = Math.min(rect.x1, rect.x2);
    var xMax = Math.max(rect.x1, rect.x2);
    var yMin = Math.min(rect.y1, rect.y2);
    var yMax = Math.max(rect.y1, rect.y2);

    for (var i = 0; i < stroke.length; i++) {
        var point = stroke[i];
        if (point.x < xMin || point.x > xMax || point.y < yMin || point.y > yMax) {
            return false;
        }
    }
    return true;
}

// Supprimer les traits sélectionnés
function deleteSelection() {
    if (selectedStrokes.length === 0) {
        console.log("No selection to delete.");
        return;
    }
    arrayOfStrokes = arrayOfStrokes.filter(function(stroke) {
        return selectedStrokes.indexOf(stroke) === -1;
    });
    selectedStrokes = [];
    toggleButtonsState(false);  // Désactiver les boutons
    redraw();
}

// Copier les traits sélectionnés
function copySelection() {
    if (selectedStrokes.length === 0) {
        console.log("No selection to copy.");
        return;
    }

    var newStrokes = selectedStrokes.map(function(stroke) {
        var newStroke = stroke.map(function(point) {
            return { x: point.x + copyOffset, y: point.y + copyOffset, color: point.color };
        });
        return newStroke;
    });

    arrayOfStrokes = arrayOfStrokes.concat(newStrokes);
    selectedStrokes = newStrokes; 
    redraw();
}
</script>

</body>
</html>
